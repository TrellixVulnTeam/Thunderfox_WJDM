name: Linux aarch64 Debug Build

on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-20.04

    steps:
    - name: Set Swap Space
      uses: pierotofy/set-swap-space@master
      with:
        swap-size-gb: 10

    - uses: actions/checkout@v2

    - name: Setup
      run: |
        cp mozconfigs/gh-actions/linux-aarch64-debug mozconfig

        mkdir /home/runner/crosstool
        echo "Downloading clang"
        wget -o null.txt -O /home/runner/crosstool/clang.tar.zst https://firefox-ci-tc.services.mozilla.com/api/index/v1/task/gecko.cache.level-3.toolchains.v3.linux64-clang-14.latest/artifacts/public%2Fbuild%2Fclang.tar.zst

        echo "Unpacking clang"
        tar -xvf /home/runner/crosstool/clang.tar.zst -C /home/runner/win-crosstool > /dev/null 2>&1

        rm /home/runner/crosstool/clang.tar.zst

        ./mach bootstrap
        ./tdf-setup --gh-actions

        /home/runner/.cargo/bin/rustup target add aarch64-unknown-linux-gnu

    - name: Build
      run: |
        ./mach build

    - name: Package
      run: |
        ./mach package

    - name: Copy
      run: |
        DISPLAY_VERSION=`cat browser/config/version_display.txt`
        mkdir /home/runner/output
        cp obj-aarch64-unknown-linux-gnu/dist/thunderfox-$DISPLAY_VERSION.en-US.linux-aarch64.tar.bz2 /home/runner/output/

    - name: Publish
      uses: actions/upload-artifact@master
      with:
        name: thunderfox-linux-aarch64
        path: /home/runner/output
